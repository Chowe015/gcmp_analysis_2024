---
title: "Global Coral Microbiome Project: Statistical Analysis and Modelling Workflow 2024"
authors: "Colin Howe, Sofia Roitman"
start date: "01/17/2024"
current date: "03/29/2024"
output: html_document
---

# First, Set working Directory load library and Import Data into Phyloseq
```{r}
# Command for setting your work directory
knitr::opts_knit$set("C:/Users/Colin Howe/Desktop/PSU Doctoral Program/GCMP_Working/gcmp_analysis_2024/Analysis/Neutral_Model_Analysis/a1_neutrality_by_compartment_all")
                 
# Print your working directory

```

## Load required libraries. 
```{r, message=FALSE, warning=FALSE} 
library(BiocManager)
library(phyloseq)
library(tidyverse)
library(qiime2R)
library(DESeq2)
library(ComplexHeatmap)
library(ade4)
library(vegan)
library(ggplot2)
library(microbiome)
library(dendextend)
library(RVAideMemoire)
library(ape)
library(RColorBrewer)
library(ggsignif)
library(ANCOMBC)
library(biomformat)
library(cowplot) ## needed for ggdraw 
```

```{r}
setwd("C:/Users/Colin Howe/Desktop/gcmp_combined_complete/combined_tables/m_expedition")

compartment <- c("M","T","S")
expedition <- c("E1","E3","E4","E5","E7","E8","E9","E10","E11")

for (c in compartment){
 for (e in expedition){
 
   print(paste("Combination:",c,e))
   
   }
}

#print(paste("Imported GCMP OTU Table"))

## import table 
glom_table <- read.table("./mucus/M_glom_table.tsv", sep = "\t",header = TRUE,row.names=1,check.name=FALSE)
#import taxonomy
glom_tax <- read.table("./mucus/M_glom_taxonomy.tsv", sep = "\t",header = TRUE,row.names=1 ,check.name=FALSE)

# import mapping file
glom_mapping <-read.table("./mucus/M_glom_metadata.csv", sep = ",",header = TRUE,row.names=1,check.name=FALSE)

# create matrix format for OTU and taxonomy table
OTU <- otu_table(as.matrix(glom_table), taxa_are_rows = TRUE)
tax1 = tax_table(as.matrix(glom_tax))

# Set metadata
SAMPLE <- sample_data(glom_mapping)

# Create Working phyloseq object
main_phylo <- phyloseq(OTU,SAMPLE,tax1)
main_phylo

install.packages("readr")
    library(readr)
column <- c("m","m.ci","m.mle","maxLL",	"binoLL",	"poisLL",	"Rsqr",	"Rsqr.bino",	"Rsqr.pois",	"RMSE",	"RMSE.bino",	"RMSE.pois","AIC","BIC","AIC.bino",	"BIC.bino",	"AIC.pois",	"BIC.pois","N","Samples","Richness","Detect")
expedition <- c("E1","E2","E3","E7","E10","E11","E12","E15")
remove(file_list)

file_list <- list.files(pattern = "\\.tsv$", full.names = TRUE)
combined_data <- data.frame()

#empty_df <- data.frame(matrix(ncol = length(column), nrow = 0))
#  colnames(empty_df) <- column

for (file in file_list) {
     current_df <- read.delim(file, header = TRUE, sep = "\t")
     combined_data <- rbind(combined_data, current_df)
   }

combined_data$expedition <- expedition
write.table(combined_data,file="S_ncm_stats_results.tsv",sep = "\t",row.names = FALSE)

```

# Import OTU Table Taxonomy and Tree from Qiime2 and import Metadata
```{r,message=FALSE, warning=FALSE}
#Import from .qza file into a phyloseq object
asv <- qza_to_phyloseq(features = "./miseq_complete_nomito_table.qza")

#### Import Metadata read.table
metadata <- read.table(file = "./gcmp_E12_complete_mapping25.txt",header=T,comment.char="", row.names=1, sep="\t")


### Import Tree file from biom output tree.nwk
tree <- read_tree("./tree.nwk")

### Import taxonomy from biom output as .tsv format using read.table
taxonomy <- read.table(file = "./taxonomy.tsv", sep = "\t", header = T ,row.names = 1)

# clean the taxonomy
##code referenced from Yan Hui: email me@yanh.org github: yanhui09
tax <- taxonomy %>%
  select(Taxon) %>% 
  separate(Taxon, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species"), "; ")

tax.clean <- data.frame(row.names = row.names(tax),
                        Kingdom = str_replace(tax[,1], "k__",""),
                        Phylum = str_replace(tax[,2], "p__",""),
                        Class = str_replace(tax[,3], "c__",""),
                        Order = str_replace(tax[,4], "o__",""),
                        Family = str_replace(tax[,5], "f__",""),
                        Genus = str_replace(tax[,6], "g__",""),
                        Species = str_replace(tax[,7], "s__",""),
                        stringsAsFactors = FALSE)

tax.clean[is.na(tax.clean)] <- ""
tax.clean[tax.clean=="__"] <- ""

for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,7] != ""){
    tax.clean$Species[i] <- paste(tax.clean$Genus[i], tax.clean$Species[i], sep = " ")
  } else if (tax.clean[i,2] == ""){
    kingdom <- paste("Unclassified", tax.clean[i,1], sep = " ")
    tax.clean[i, 2:7] <- kingdom
  } else if (tax.clean[i,3] == ""){
    phylum <- paste("Unclassified", tax.clean[i,2], sep = " ")
    tax.clean[i, 3:7] <- phylum
  } else if (tax.clean[i,4] == ""){
    class <- paste("Unclassified", tax.clean[i,3], sep = " ")
    tax.clean[i, 4:7] <- class
  } else if (tax.clean[i,5] == ""){
    order <- paste("Unclassified", tax.clean[i,4], sep = " ")
    tax.clean[i, 5:7] <- order
  } else if (tax.clean[i,6] == ""){
    family <- paste("Unclassified", tax.clean[i,5], sep = " ")
    tax.clean[i, 6:7] <- family
  } else if (tax.clean[i,7] == ""){
    tax.clean$Species[i] <- paste("Unclassified ",tax.clean$Genus[i], sep = " ")
  }
}

# create matrix format for OTU and taxonomy table
OTU <- otu_table(as.matrix(asv), taxa_are_rows = TRUE)
tax1 = tax_table(as.matrix(tax.clean))

# Set metadata
SAMPLE <- sample_data(metadata)

# Create Working phyloseq object
main_phylo <- phyloseq(OTU,tax1,SAMPLE,tree)

# visualize tax table
table(tax_table(main_phylo)[,"Kingdom"])

# remove unknown bacteria or unassigned
phylo_noking <-main_phylo %>%
  phyloseq::subset_taxa(!Kingdom %in% c("Unassigned","Unclassified d__Bacteria","d__Eukaryota")) %>%
  phyloseq::subset_taxa(!Phylum %in% c("Unclassified Unassigned","Unclassified d__Archaea","Unclassified d__Bacteria","Unclassified d__Eukaryota")) %>%
  phyloseq::subset_taxa(!Family %in% c("Mitochondria","Chloroplast","mitochondria"))

# verify present taxa in table
table(tax_table(phylo_noking)[,"Kingdom"])
phylo_noking

# Remove any samples with less than 1 read
phylo = prune_samples(sample_sums(phylo_noking)>1, phylo_noking)
phylo

# rarefy to even depth
rarefied = rarefy_even_depth(phylo, rngseed=111, sample.size=1000, replace=F, trimOTUs = TRUE)
rarefied

###Agglomerate taxa to family 
glom <- tax_glom(rarefied, taxrank = 'Family', NArm = TRUE)
glom

# Subset only corals from database
subject = subset_samples(glom, outgroup=="n" & subset_col=="yes")
subject

phyloseq::tax_table(subject)%>%
  as.data.frame()%>%
  rownames_to_column("id") -> glom_tax

subset_samples(subject, country=="Colombia" & BiologicalMatter =="Coral Mucus") -> glom_muc
glom_muc
subset_samples(subject, country=="Colombia" & BiologicalMatter =="Coral Tissue") -> glom_tis
glom_tis
subset_samples(subject, country=="Colombia" & BiologicalMatter =="Coral Skeleton") -> glom_ske
glom_ske
subset_samples(glom, country=="Colombia" & BiologicalMatter =="water") -> water
water
subset_samples(glom, country=="Colombia" & BiologicalMatter =="Sediment") -> sediment
sediment

#subset_samples(glom,BiologicalMatter == "Coral Skeleton") -> glom_ske_table
```

##Burns Model Script
```{r}
print(paste("Create Neutral Model Function"))
sncm.fit <- function(spp, pool=NULL, stats=TRUE, taxon=NULL){
  require(minpack.lm)
  require(Hmisc)
  require(stats4)
  
  options(warn=-1)
  
  #Calculate the number of individuals per community
  N <- mean(apply(spp, 1, sum))
  
  #Calculate the average relative abundance of each taxa across communities
  if(is.null(pool)){
    p.m <- apply(spp, 2, mean)
    p.m <- p.m[p.m != 0]
    p <- p.m/N
  } else {
    p.m <- apply(pool, 2, mean)
    p.m <- p.m[p.m != 0]
    p <- p.m/N
  }
  
  #Calculate the occurrence frequency of each taxa across communities
  spp.bi <- 1*(spp>0)
  freq <- apply(spp.bi, 2, mean)
  freq <- freq[freq != 0]
  #Combine
  C <- merge(p, freq, by=0)
  C <- C[order(C[,2]),]
  C <- as.data.frame(C)
  C.0 <- C[!(apply(C, 1, function(y) any(y == 0))),] #Removes rows with any zero (absent in either source pool or local communities)
  p <- C.0[,2]
  freq <- C.0[,3]
  names(p) <- C.0[,1]
  names(freq) <- C.0[,1]
  
  #Calculate the limit of detection
  d = 1/N
  
  ##Fit model parameter m (or Nm) using Non-linear least squares (NLS)
  m.fit <- nlsLM(freq ~ pbeta(d, N*m*p, N*m*(1-p), lower.tail=FALSE), start=list(m=0.1))
  m.ci <- confint(m.fit, 'm', level=0.95)
  
  ##Fit neutral model parameter m (or Nm) using Maximum likelihood estimation (MLE)
  sncm.LL <- function(m, sigma){
    R = freq - pbeta(d, N*m*p, N*m*(1-p), lower.tail=FALSE)
    R = dnorm(R, 0, sigma)
    -sum(log(R))
  }
  
  m.mle <- mle(sncm.LL, start=list(m=0.1, sigma=0.1), nobs=length(p),method="Nelder-Mead")
  
  ##Calculate Akaike's Information Criterion (AIC)
  aic.fit <- AIC(m.mle, k=2)
  bic.fit <- BIC(m.mle)
  
  ##Calculate goodness-of-fit (R-squared and Root Mean Squared Error)
  freq.pred <- pbeta(d, N*coef(m.fit)*p, N*coef(m.fit)*(1-p), lower.tail=FALSE)
  Rsqr <- 1 - (sum((freq - freq.pred)^2))/(sum((freq - mean(freq))^2))
  RMSE <- sqrt(sum((freq-freq.pred)^2)/(length(freq)-1))
  
  pred.ci <- binconf(freq.pred*nrow(spp), nrow(spp), alpha=0.01, method="wilson", return.df=TRUE)
  
  ##Calculate AIC for binomial model
  bino.LL <- function(mu, sigma){
    R = freq - pbinom(d, N, p, lower.tail=FALSE)
    R = dnorm(R, mu, sigma)
    -sum(log(R))
  }
  bino.mle <- mle(bino.LL, start=list(mu=0, sigma=0.1), nobs=length(p))
  
  aic.bino <- AIC(bino.mle, k=2)
  bic.bino <- BIC(bino.mle)
  
  ##Goodness of fit for binomial model
  bino.pred <- pbinom(d, N, p, lower.tail=FALSE)
  Rsqr.bino <- 1 - (sum((freq - bino.pred)^2))/(sum((freq - mean(freq))^2))
  RMSE.bino <- sqrt(sum((freq - bino.pred)^2)/(length(freq) - 1))
  
  bino.pred.ci <- binconf(bino.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
  
  ##Calculate AIC for Poisson model
  pois.LL <- function(mu, sigma){
    R = freq - ppois(d, N*p, lower.tail=FALSE)
    R = dnorm(R, mu, sigma)
    -sum(log(R))
  }
  pois.mle <- mle(pois.LL, start=list(mu=0, sigma=0.1), nobs=length(p))
  
  aic.pois <- AIC(pois.mle, k=2)
  bic.pois <- BIC(pois.mle)
  
  ##Goodness of fit for Poisson model
  pois.pred <- ppois(d, N*p, lower.tail=FALSE)
  Rsqr.pois <- 1 - (sum((freq - pois.pred)^2))/(sum((freq - mean(freq))^2))
  RMSE.pois <- sqrt(sum((freq - pois.pred)^2)/(length(freq) - 1))
  
  pois.pred.ci <- binconf(pois.pred*nrow(spp), nrow(spp), alpha=0.05, method="wilson", return.df=TRUE)
  
  ##Results
  if(stats==TRUE){
    fitstats <- data.frame(m=numeric(), m.ci=numeric(), m.mle=numeric(), maxLL=numeric(), binoLL=numeric(), poisLL=numeric(), Rsqr=numeric(), Rsqr.bino=numeric(), Rsqr.pois=numeric(), RMSE=numeric(), RMSE.bino=numeric(), RMSE.pois=numeric(), AIC=numeric(), BIC=numeric(), AIC.bino=numeric(), BIC.bino=numeric(), AIC.pois=numeric(), BIC.pois=numeric(), N=numeric(), Samples=numeric(), Richness=numeric(), Detect=numeric())
    fitstats[1,] <- c(coef(m.fit), coef(m.fit)-m.ci[1], m.mle@coef['m'], m.mle@details$value, bino.mle@details$value, pois.mle@details$value, Rsqr, Rsqr.bino, Rsqr.pois, RMSE, RMSE.bino, RMSE.pois, aic.fit, bic.fit, aic.bino, bic.bino, aic.pois, bic.pois, N, nrow(spp), length(p), d)
    return(fitstats)
  } else {
    A <- cbind(p, freq, freq.pred, pred.ci[,2:3], bino.pred, bino.pred.ci[,2:3])
    A <- as.data.frame(A)
    colnames(A) <- c('p_abundance', 'freq', 'freq.pred', 'pred.lwr', 'pred.upr', 'bino.pred', 'bino.lwr', 'bino.upr')
    if(is.null(taxon)){
      B <- A[order(A[,1]),]
    } else {
      B <- merge(A, taxon, by=0, all=TRUE)
      row.names(B) <- B[,1]
      B <- B[,-1]
      B <- B[order(B[,1]),]
    }
    return(B)
  }
}
##Identify above, below and neutral OTUs 

addf = function(freq, pred.upr, pred.lwr, padj) {
  if(freq > pred.upr){
    model = "above"
  }
  else if(freq < pred.lwr){
    model = "below"
  }
  else if(pred.upr >= freq & freq >= pred.lwr){
    model = "neutral"
  }
  return(model)
}

```


## Neutral Model test
```{r}
compartment <- c("Coral Mucus","Coral Tissue","Coral Skeleton")
for (i in compartment){

  # Subset only corals from database
sub <-subset_samples(subject, BiologicalMatter ==print(paste(i)))
sub

set.seed(111)
spp <- prune_taxa(taxa_sums(sub) > 0, sub)
spp
otu_spp = as.data.frame(t(otu_table(spp)))


## Neutral fit
neutral_mod_w = sncm.fit(otu_spp)
neutral_mod1_w = sncm.fit(otu_spp,stats = F)


print(length(neutral_mod_w$freq))

neutral_mod1_w$model = mapply(addf, neutral_mod1_w$freq, neutral_mod1_w$pred.upr, neutral_mod1_w$pred.lwr)  
length(which(neutral_mod1_w$model == "above"))
length(which(neutral_mod1_w$model == "below"))
length(which(neutral_mod1_w$model == "neutral"))

neutral_mod1_w %>% mutate(ci.mean = (pred.upr-pred.lwr),
                        SE = (ci.mean/(2*1.96)),
                        zstat = (freq/SE),
												p_value = (exp(-0.717*zstat-0.416*zstat^2)),
                        padj = (exp(-0.717*zstat-0.416*zstat^2))*length(neutral_mod1_w$model)) %>%
                        as.data.frame() %>% rownames_to_column("id")-> neutral_results_padj

neutral_results_padj$model = mapply(addf, neutral_results_padj$freq, neutral_results_padj$pred.upr, neutral_results_padj$pred.lwr, neutral_results_padj$padj)  

length(which(neutral_results_padj$model == "above"))
length(which(neutral_results_padj$model == "below"))
length(which(neutral_results_padj$model == "neutral"))


neutral_results_padj$model <- factor(neutral_results_padj$model, 
                             levels = c("above", "neutral", "below"))

## Inner_join feature table with neutral model families
inner_join(neutral_results_padj,glom_tax, by = "id") %>% as.data.frame() -> nonneutral_tax

#plot neuModel

r <- round(neutral_mod_w$Rsqr,3)
m_var <- round(neutral_mod_w$m,3)
lb1 <- paste0("R_squared",":",r)
lb2 <- paste0("migration_rate (m):",m_var)
lb3 <- paste0(paste0(i," Neutral Model"))
lb4 <-paste0(i," Log10 (Mean Relative abundance)")
lb5 <- paste0(i," Occurance frequency")

p_neuM_coral2=ggplot(neutral_results_padj, aes(x=log10(p_abundance), y=freq, color = model))+
  geom_point(shape=19, alpha=0.7, size=2.5)+
  geom_line(aes(x=log10(p_abundance), y=freq.pred),
            color="blue",linetype="solid",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.lwr),
            color="blue",linetype="dashed",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.upr),
            color="blue",linetype="dashed",linewidth=1)+
    scale_colour_manual(name="OTUs",
                      values=c("#E41A1C", "#999999", "#FF7F00","purple"),
                      breaks=c("above", "neutral", "below","neutral_significant"),
                      labels=c("Over-represented", "Neutrally-distributed", "Under-represented","Significant_low_weight"))+
  xlab(lb4) + ylab(lb5)+
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", size=15),
        axis.title.y = element_text(face="bold", size=15),
        axis.text.x = element_text(colour = "black", size=12),
        axis.text.y = element_text(colour = "black", size=12), 
        legend.title = element_text(size=11.5, face = "bold"),
        legend.text = element_text(size=11.5),
        legend.position="none") + ggtitle(lb3)+ theme(plot.title = element_text(hjust = 0.5, size=15, face="bold"))


neutral_plot2 = p_neuM_coral2 + annotate("text", x = -4.0, y=0.9, size=6, label=lb1, 
                                        fontface="bold", color="black",
                                        parse=TRUE) +
  annotate("text", x =-4.0, y=0.8, size=6, label=lb2, 
           fontface="bold", color="black",
           parse=TRUE)
ncm_plot_name <- paste0(i,"Neutral_model_plot.pdf")
ggsave(ncm_plot_name, neutral_plot2, width = 15, height = 10, dpi= 600)

#### create ASV tables by id ** This file will be used in microbe_neutral_compartment.R and picrust2_neutral_table_generator.R
print(paste("Generating Agglomerated ASV Table dataset..."))
phyloseq::otu_table(sub)%>%
  as.data.frame()%>%
  rownames_to_column("id") -> glom_otu_table

## Output .tsv from the otu table file
glom_otu_name <- paste0(i,"_glom_table.tsv")
write.table(glom_otu_table, file =glom_otu_name ,sep = "\t",row.names = FALSE)

#### create taxonomy tables by id  ** This 

paste(print("Printing Agglomerated Taxonomy Table"))
phyloseq::tax_table(sub)%>%
  as.data.frame() %>%
  rownames_to_column("id") %>%
  select(-c("Genus","Species"))-> glom_taxonomy

## Output .tsv from the taxonomy file
glom_taxonomy_name <- paste0(i,"_glom_taxonomy.tsv")
write.table(glom_taxonomy, file =glom_taxonomy_name,sep = "\t", row.names = FALSE)

paste(print("Creating glom mapping file"))
phyloseq::sample_data(sub)%>%
  as.data.frame() -> glom_mapping

## Output .csv from the taxonomy file
glom_mapping_name <- paste0(i,"_glom_metadata.tsv")
write.table(glom_mapping, file =glom_mapping_name,sep = "\t", row.names = FALSE)
}

```

```{r}
###coral communities
set.seed(111)
spp <- prune_taxa(taxa_sums(glom_ske) > 0, glom_ske)
spp
otu_spp = as.data.frame(t(otu_table(spp)))

pool <- prune_taxa(taxa_sums(sediment) > 0, sediment)
pool

otu_pool = as.data.frame(t(otu_table(pool)))

spp_subset<-"Skeleton"
pool_subset<-"Sediment"
## pull sample names from spp
#all_samples <- sample_names(spp)

## count length of pool
#samples_to_keep <- dim(otu_table(pool))[2]

## randomly sample length of spp from pool
#rand_sample_name <- sample(all_samples,samples_to_keep)

## Subset Samples
#spp_sample_prune <- prune_samples(rand_sample_name,spp)

#otu_spp = as.data.frame(t(otu_table(spp_sample_prune)))

## Subset Taxa
#taxa_names <- rownames(otu_table(pool))
## count length of pool
#names_to_keep <- dim(otu_table(spp))[1]
# keept taxa names
#rand_name <- sample(taxa_names,names_to_keep)

# prune taxa
#pool_taxa <- prune_taxa(rand_name,pool)
#otu_pool = as.data.frame(t(otu_table(pool_taxa)))

## Neutral fit
mod_w_coral = sncm.fit(otu_spp,otu_pool)
mod1_w_coral = sncm.fit(otu_spp,otu_pool,stats = F)

mod1_w_coral %>% mutate(ci.mean = (pred.upr-pred.lwr),
                        SE = (ci.mean/(2*1.96)),
                        zstat = (freq/SE),
												p_value = (exp(-0.717*zstat-0.416*zstat^2)),
                        padj = (exp(-0.717*zstat-0.416*zstat^2))*length(mod1_w_coral$model)) %>%
                        as.data.frame() %>% rownames_to_column("id")-> neutral_results_padj

neutral_results_padj$model = mapply(addf, neutral_results_padj$freq, neutral_results_padj$pred.upr, neutral_results_padj$pred.lwr, neutral_results_padj$padj)  

length(which(neutral_results_padj$model == "above"))
length(which(neutral_results_padj$model == "below"))
length(which(neutral_results_padj$model == "neutral"))


neutral_results_padj$model <- factor(neutral_results_padj$model, 
                             levels = c("above", "neutral", "below"))

## Inner_join feature table with neutral model families
inner_join(neutral_results_padj,glom_tax, by = "id") %>% as.data.frame() -> nonneutral_tax

psuedo_spp_name <- paste0(spp_subset,"_subset_",pool_subset,"_abundance_neutral_table.tsv")
  (write.table(nonneutral_tax, file =psuedo_spp_name,sep="\t", row.names = FALSE))

############## Switch Frequency and Abundance######################################################
## Neutral fit
mod_w_coral1 = sncm.fit(otu_pool,otu_spp)
mod1_w_coral1 = sncm.fit(otu_pool,otu_spp,stats = F)

mod1_w_coral1 %>% mutate(ci.mean = (pred.upr-pred.lwr),
                        SE = (ci.mean/(2*1.96)),
                        zstat = (freq/SE),
												p_value = (exp(-0.717*zstat-0.416*zstat^2)),
                        padj = (exp(-0.717*zstat-0.416*zstat^2))*length(mod1_w_coral1$model)) %>%
                        as.data.frame() %>% rownames_to_column("id")-> neutral_results_padj2

neutral_results_padj2$model = mapply(addf, neutral_results_padj2$freq, neutral_results_padj2$pred.upr, neutral_results_padj2$pred.lwr, neutral_results_padj2$padj)  

length(which(neutral_results_padj2$model == "above"))
length(which(neutral_results_padj2$model == "below"))
length(which(neutral_results_padj2$model == "neutral"))


neutral_results_padj2$model <- factor(neutral_results_padj2$model, 
                             levels = c("above", "neutral", "below"))

inner_join(neutral_results_padj2,glom_tax, by = "id") %>% as.data.frame() -> nonneutral_tax2
psuedo_pool_name <- paste0(pool_subset,"_subset_",spp_subset,"_abundance_neutral_table.tsv")
  (write.table(nonneutral_tax2, file =psuedo_pool_name,sep="\t", row.names = FALSE))

```

## Plot Neutral Model
```{r}
###Set Results parameters for plot statistics
r <- round(mod_w_coral$Rsqr,3)
m_var <- round(mod_w_coral$m,3)
lb1 <- paste0("R_squared",":",r)
lb2 <- paste0("migration_rate (m):",m_var)
lb3 <- paste0(spp_subset,"&",pool_subset," Disperal Neutral Model")
lb4 <-paste0(pool_subset," Log10 (Mean Relative abundance)")
lb5 <- paste0(spp_subset," Occurance frequency")

###### draft neutral model plot #############
p_neuM_coral=ggplot(neutral_results_padj, aes(x=log10(p_abundance), y=freq, color = model))+
  geom_point(shape=19, alpha=0.7, size=2.5)+
  geom_line(aes(x=log10(p_abundance), y=freq.pred),
            color="blue",linetype="solid",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.lwr),
            color="blue",linetype="dashed",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.upr),
            color="blue",linetype="dashed",linewidth=1)+
    scale_colour_manual(name="OTUs",
                      values=c("#E41A1C", "#999999", "#FF7F00","purple"),
                      breaks=c("above", "neutral", "below","neutral_significant"),
                      labels=c("Over-represented", "Neutrally-distributed", "Under-represented","Significant_low_weight"))+
  xlab(lb4) + ylab(lb5)+
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", size=15),
        axis.title.y = element_text(face="bold", size=15),
        axis.text.x = element_text(colour = "black", size=12),
        axis.text.y = element_text(colour = "black", size=12), 
        legend.title = element_text(size=11.5, face = "bold"),
        legend.text = element_text(size=11.5),
        legend.position="none") + ggtitle(lb3)+ theme(plot.title = element_text(hjust = 0.5, size=15, face="bold"))

p_neuM_coral1 = p_neuM_coral + annotate("text", x = -3.0, y=0.9, size=6, label=lb1, 
                                        fontface="bold", color="black",
                                        parse=TRUE) +
  annotate("text", x = -3.0, y=0.8, size=6, label=lb2, 
           fontface="bold", color="black",
           parse=TRUE)

########################## Switch Frequency and Abundance Plot
#plot neuModel

r <- round(mod_w_coral1$Rsqr,3)
m_var <- round(mod_w_coral1$m,3)
lb1 <- paste0("R_squared",":",r)
lb2 <- paste0("migration_rate (m):",m_var)
lb3 <- paste0(paste0(spp_subset,"&",pool_subset," Disperal Neutral Model"))
lb4 <-paste0(spp_subset," Log10 (Mean Relative abundance)")
lb5 <- paste0(pool_subset," Occurance frequency")

p_neuM_coral2=ggplot(neutral_results_padj2, aes(x=log10(p_abundance), y=freq, color = model))+
  geom_point(shape=19, alpha=0.7, size=2.5)+
  geom_line(aes(x=log10(p_abundance), y=freq.pred),
            color="blue",linetype="solid",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.lwr),
            color="blue",linetype="dashed",linewidth=1)+
  geom_line(aes(x=log10(p_abundance), y=pred.upr),
            color="blue",linetype="dashed",linewidth=1)+
    scale_colour_manual(name="OTUs",
                      values=c("#E41A1C", "#999999", "#FF7F00","purple"),
                      breaks=c("above", "neutral", "below","neutral_significant"),
                      labels=c("Over-represented", "Neutrally-distributed", "Under-represented","Significant_low_weight"))+
  xlab(lb4) + ylab(lb5)+
  theme_bw() +
  theme(axis.title.x = element_text(face="bold", size=15),
        axis.title.y = element_text(face="bold", size=15),
        axis.text.x = element_text(colour = "black", size=12),
        axis.text.y = element_text(colour = "black", size=12), 
        legend.title = element_text(size=11.5, face = "bold"),
        legend.text = element_text(size=11.5),
        legend.position="none") + ggtitle(lb3)+ theme(plot.title = element_text(hjust = 0.5, size=15, face="bold"))


neutral_plot2 = p_neuM_coral2 + annotate("text", x = -3.0, y=0.9, size=6, label=lb1, 
                                        fontface="bold", color="black",
                                        parse=TRUE) +
  annotate("text", x =-3.0, y=0.8, size=6, label=lb2, 
           fontface="bold", color="black",
           parse=TRUE)

#ggsave("Tissue_sig_neutral_model_plot.jpg", p_neuM_coral1, width = 20, height = 10, dpi= 600)


mp_ncm = ggdraw() +
  draw_plot(p_neuM_coral1, x = 0.01, y = 0.1, width = 0.49, height = 0.8) + 
  draw_plot(neutral_plot2, x = 0.51, y = 0.1, width = 0.49, height = 0.8) 
mp_ncm

## Print Neutral Model Plot
ncm_name <- paste0("Miseq",spp_subset,"_",pool_subset,"_neutral_model_Plot.pdf")
ggsave(paste0(ncm_name), mp_ncm, width = 20, height = 10, dpi= 600)  
```

## Psudo Tables 
```{r}
Tissue_glom_table <-read.table("./Tissue/T_glom_table.tsv",header=T, sep = "\t", check.names=FALSE)
Tissue_glom_tax <-read.table("./Tissue/T_glom_taxonomy.tsv",header=T,sep = "\t", check.names=FALSE)

Tissue_above_map <-read.table("./Tissue/Tissue_above_metadata.txt",header=T,sep = "\t", check.names=FALSE)
Tissue_below_map <-read.table("./Tissue/Tissue_below_metadata.txt",header=T,sep = "\t", check.names=FALSE)
Tissue_neutral_map <-read.table("./Tissue/Tissue_neutral_metadata.txt",header=T,sep = "\t", check.names=FALSE)

rbind(Tissue_above_map,Tissue_below_map,Tissue_neutral_map) -> test_map

## Subset feature table
#phyloseq::otu_table(glom)%>%
#  as.data.frame()%>%
#  rownames_to_column("id") -> Tissue_glom_table

## Subet taxonomy table
#phyloseq::tax_table(glom)%>%
#  as.data.frame() %>%
#  rownames_to_column("id") -> Tissue_glom_tax

## Subet Mapping file
#phyloseq::sample_data(glom) %>% as.data.frame() -> Tissue_glom_mapping


biosample="Tissue"
# Subset Taxonomy and join with neutral model results
neutral = c("above","below")
for (b in neutral){
## Inner_join will connect  ASV id with taxonomy using id column
inner_join(neutral_results_padj,Tissue_glom_tax, by = "id") -> non_neutral_tax

## Subset ASV from each model and signifcance 
sig_neutral_tax = select(filter(non_neutral_tax, model == b & padj <=0.05),id,p_abundance,freq,padj,Phylum,Class,Order,Family,model)

#subset otu table based on neutral results and rename column names
neutral_table <-subset(Tissue_glom_table, id  %in%  sig_neutral_tax$id)
l = length(neutral_table)
colnames(neutral_table)[2:l] <- paste(colnames(neutral_table)[2:l], b, sep = "_")

## Create new columns for the metadata data
T_glom_mapping %>% mutate(psuedo_sample_name = paste(colnames(neutral_table)[2:l]),
                         compartment_neutraility = paste(biosample,b, sep = '_'),
                         compartment = paste (biosample),
                         neutraility = paste(b)) %>% 
                        select(psuedo_sample_name,sample_name_backup, host_scientific_name,expedition_number,political_area,ocean_area,compartment_neutraility,compartment,neutraility) %>% 
                        as.data.frame() -> glom_metadata
## Subset significant results with taxonomy to retain only significant taxonomy
#subset_tax <- subset(Tissue_glom_tax, id %in% sig_neutral_tax$id)# %>% select(-c("Genus","Species"))

psuedo_table_name <- paste0(biosample,"_",b,"_table.tsv")
  (write.table(neutral_table, file =psuedo_table_name,sep="\t", row.names = FALSE))
  
psuedo_map_name <- paste0(biosample,"_",b,"_metadata.csv") ## remember to combine above, below and neutral in excel
  (write.table(glom_metadata, file =psuedo_map_name,sep=",", row.names = FALSE))
  
# psuedo_tax_name <- paste0(biosample,"_",b,"_taxonomy.tsv")
#  (write.table(subset_tax, file =psuedo_tax_name,sep="\t", row.names = FALSE))
}

################## Subset ASV for the neutral taxa ####################
sig_neutral_ref = select(filter(non_neutral_tax, model == "neutral" & padj >=0.05),id,p_abundance,freq,padj,Phylum,Class,Order,Family,model)

#subset otu table based on neutral results and rename column names
neutral_table_test <-subset(Tissue_glom_table, id  %in%  sig_neutral_ref$id)
l = length(neutral_table_test)
colnames(neutral_table_test)[2:l] <- paste(colnames(neutral_table_test)[2:l], "neutral", sep = "_")


### Write neutral tables and mapping file
neutral_table_name <- paste0(biosample,"_neutral_table.tsv")
  (write.table(neutral_table_test, file =neutral_table_name,sep="\t", row.names = FALSE))
  
#neutral_map_name <- paste0(biosample,"_neutral_metadata.csv") ## remember to combine above, below and neutral in excel
#  (write.table(neutral_map_name, file =psuedo_map_name,sep=",", row.names = FALSE))

## Merging above and Below tables for phyloseq object

above_table <- read.table("./Tissue_above_table.tsv",header = TRUE,sep="\t", check.names=FALSE)
below_table <- read.table("./Tissue_below_table.tsv",header = TRUE,sep="\t", check.names=FALSE)
neutral_table <-read.table("./Tissue_neutral_table.tsv",header = TRUE,sep="\t", check.names=FALSE)

### Merge above and below tables
merge(above_table, below_table, by=0,all=T) -> merge_table

merge_table %>% mutate(id = coalesce(id.x,id.y)) %>% 
    relocate(id) %>%  
  select(!c(id.x,id.y,Row.names))-> merge_test
merge_test[is.na(merge_test)] <-0



## Merge with above and below tables
merge(merge_test,neutral_table_test,by=0,all=T) -> full_table
full_table %>% mutate(id = coalesce(id.x,id.y)) %>% 
    relocate(id) %>%  
  select(!c(id.x,id.y,Row.names))-> full_table
full_table[is.na(full_table)] <-0

#write.table(full_table,file = "merged_table_test.txt", sep="\t",row.names = FALSE)
#test_biom <-make_biom(merge_test) ## unknown biom format makes this difficult to import into qiime2
#write_biom(test_biom,biom_file = "tissue_above_biom")

l = length(neutral_table_test)
T_glom_mapping %>% mutate(psuedo_sample_name = paste(colnames(neutral_table_test)[2:l]),
                         compartment_neutraility = paste("Tissue", "neutral", sep = '_'),
                         compartment = paste ("Tissue"),
                         neutraility = paste("neutral")) %>% 
                        select(psuedo_sample_name,sample_name_backup, host_scientific_name,expedition_number,political_area,ocean_area,compartment_neutraility,compartment,neutraility) %>% 
                        as.data.frame() -> glom_metadata

## Subset taxonomy file 
taxonomy2 <- read.table(file = "gcmp_qiime_input/taxonomy.tsv", sep = "\t", header = T)
colnames(taxonomy2)[1] <-"id"
neutral_tax <-subset(taxonomy2, id  %in%  full_table$id)

## Print output files
print(paste("Writing Combined Psudo_table across compartments"))
psudo_table_name <- paste0(biosample,"_combined_psudo_table.tsv")
write.table(merge_tab, file=psudo_table_name, sep="\t",row.names = FALSE)



```

## Neutral Phyloseq Object      
```{r}
## ancombc analysis
library(ANCOMBC)

#Mucus
mucus_table <-read.table("./Mucus/mucus_combined_psudo_table.tsv",header=T,sep="\t",check.names=FALSE)
mucus_tax <-read.table("./Mucus/Mucus_combined_psudo_tax.tsv", header=T,sep="\t",check.names=FALSE)
mucus_mapping <-read.table("./Mucus/Mucus_combined_mapping.csv", header=T,sep=",", check.names=FALSE)

#Tissue
tissue_table <-read.table("./Tissue/Tissue_combined_psudo_table.tsv",row.names=1,header=T,sep="\t",  check.names=FALSE)
tissue_tax <-read.table("./Tissue/Tissue_combined_psudo_tax.tsv",header=T,sep="\t", check.names=FALSE)
tissue_mapping <-read.table("./Tissue/Tissue_combined_mapping.csv",header=T,sep=",",  check.names=FALSE)

#Skeleton
skeleton_table <-read.table("./Skeleton/Skeleton_combined_psudo_table.tsv",header=T,sep="\t",  check.names=FALSE)
skeleton_tax <-read.table("./Skeleton/Skeleton_combined_psudo_tax.tsv",header=T,sep="\t",  check.names=FALSE)
skeleton_mapping <-read.table("./Skeleton/Skeleton_combined_mapping.csv", sep=",", check.names=FALSE)

## format import files 
mucus_table <- as.data.frame(mucus_table)
class(mucus_table) <- "numeric"
as.numeric(mucus_table)
# taxa 


# create matrix format for OTU and taxonomy table
MOTU <- otu_table(as.matrix(mucus_table), taxa_are_rows = FALSE)
Mtax1 = tax_table(as.matrix(mucus_tax))

# Set metadata
MSAMPLE <- sample_data(mucus_mapping)

# Create Working phyloseq object
neutral_phylo <- phyloseq(MOTU,Mtax1,MSAMPLE,tree)
neutral_phylo


```

## Linear regression analysis
```{r}
## Set working directory
setwd("C:/Users/Colin Howe/Desktop/gcmp_combined_complete")
##load excel library
library(Hmisc)
library(readxl)
## load data table
#results_table <- read.table(file = "./neutral_results_table.txt",header=T,comment.char="",sep="\t")
miseq_table <- read_excel("../miseq_hiseq_neutral_results_table.xlsx", sheet = "miseq")
hiseq_table <- read_excel("../miseq_hiseq_neutral_results_table.xlsx", sheet = "hiseq")

as.data.frame(miseq_table) %>% filter(region!="Colombia" & sample_name!="E10_tissue")-> miseq_df
as.data.frame(hiseq_table) -> hiseq_df

#p <- ggplot(hiseq_table, aes(x ="Rsqr", y = "region")) +
#    geom_point()

## Character parameters factors
compartment = factor(hiseq_df$compartment)
expedition = factor(hiseq_df$expedition)
ocean = factor(hiseq_df$ocean)
region = factor(hiseq_df$region)

## Continuous Variables
Rsquared = hiseq_df$Rsqr
migration = hiseq_df$m
faith = hiseq_df$faith_pd
faithsr = hiseq_df$host_sp_count
n_samples = hiseq_df$samples

## neutral and non-neutral taxa count
above = hiseq_df$n_above
neutral = hiseq_df$n_neutral
below = hiseq_df$n_below
total_taxa <- hiseq_df$total

## Comparment
test_r <- lm(Rsquared ~ compartment)
summary(test_r)
test_m <- lm(migration ~ expedition)
summary(test_m)

## Host diversity
test_r2 <- lm(Rsquared ~ faith)
summary(test_r2)
test_m2 <- lm(migration ~ faith)
summary(test_m2)

## Region
test_r3 <- lm(Rsquared ~ expedition)
summary(test_r3)
test_m3 <- lm(migration ~ expedition)
summary(test_m3)

## continuous data
select(hiseq_df, c("Rsqr","m","samples","faith_pd","total","host_sp_count")) ->hiseq_subset

res2 <- rcorr(as.matrix(hiseq_subset))
res2

cor.test(migration,faith,method = "pearson") -> m_faith 
cor.test(migration,n_samples,method = "pearson") -> m_samples
cor.test(Rsquared,n_samples,method = "pearson") -> r_samples
cor.test(Rsquared,faith,method = "pearson") -> r_faith
## Plot Linear regression
#faith_m_coe <- paste0("fatihpd_pvalue:\n",round(category_migration_test$coefficients[7],7))
pearson_coe <- paste0("Pearson_pvalue:\n",round(m_faith$p.value,4))
pearson_nsample <- paste0("Pearson_pvalue:\n",round(m_samples$p.value,4))
## Migration
#pearson_migration <- paste0("Pearson_pvalue:\n",round(per_r2$p.value,4))
plot(n_samples,migration, pch = 16, cex=1.3, col="#009197", main = "Hiseq Migration and Sample Count", xlab = "Sample Count", ylab ="migration (m)") + text(x=35, y=.07, label = pearson_nsample) + abline(lm(migration ~ n_samples), col="#EC8C5C") 


plot(faith,migration, pch = 16, cex=1.3, col="#009197", main = "Hiseq Migration and Coral Faith Pd", xlab = "Coral Species Diversity (faith Pd)", ylab ="migration (m)") + text(x=1500, y=.07, label = pearson_coe) + abline(lm(migration ~ faith), col="#EC8C5C") 


## Rsquared
pearson_rsample <- paste0("Pearson_pvalue:\n",round(r_samples$p.value,4))
plot(n_samples,Rsquared, pch = 16, cex=1.3, col="#009197", main = "Hiseq Rsquared and Sample Count", xlab = "Sample Count", ylab ="Rsquared(R2)") + text(x=20, y=0.7, label = pearson_rsample) + abline(lm(Rsquared ~ n_samples), col="#EC8C5C") 

pearson_rfaith <- paste0("Pearson_pvalue:\n",round(r_faith$p.value,4))
plot(faith,Rsquared, pch = 16, cex=1.3, col="#009197", main = "Hiseq Rsquared and Coral Faith Pd", xlab = "Coral Species Diversity (faith Pd)", ylab ="Rsquared (R2)") + text(x=1500, y=0.7, label = pearson_rfaith) + abline(lm(Rsquared ~ faith), col="#EC8C5C")





#write.table(migration_regression_results,file="migration_regression_results.txt", sep = "\t",row.names = TRUE)
#write.table(Rsquared_regression_results,file="R2_regression_results.txt", sep = "\t",row.names = TRUE)

##  Compartment Boxplot with R2 
coral_color =c("#009197","#EC8C5C","#8E3B97")

testp <- ggplot(hiseq_df, aes(y=Rsquared, x=compartment)) + geom_boxplot(aes(color=compartment)) + theme_classic() + geom_point(aes(color=compartment)) +labs(xlab="Rsquared", ylab="Coral_Compartments", title =" Hiseq Compartment by Region Model Fit",size =15) + theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text=element_text(size=12, face = "bold")) + theme(axis.title=element_text(size=12,face="bold")) + scale_color_manual(values=c("#009197","#EC8C5C","#8E3B97")) + geom_signif(comparisons = list(c("mucus", "tissue"), c("mucus", "skeleton"),c("tissue", "skeleton")), y_position = c(.85,1, .75))

ggsave("Hiseq_compart_by_region_modelfit_boxlot.pdf", testp, width = 10, height = 10, dpi= 600)
```

## Faith Pd  Analysis
```{r}
coral_object <-subset_samples(coral, BiologicalMatter == "Coral Mucus") # all corals without out groups, environmental samples & subset expeditions (i.e, singapore).
coral_object

# pull out sample data 
phyloseq::sample_data(coral_object) %>%  
    group_by(sample_name_backup, expedition_number,BiologicalMatter) %>%
  as.data.frame() %>%
  select(sample_name_backup, expedition_number,BiologicalMatter) -> microbial_faith

#Microbial Phyloseq Pd analysis 
estimate_pd(coral_object) %>%
  as.data.frame() -> microbial_faith_pd

microbial_faith$faith_pd <- microbial_faith_pd$PD
microbial_faith$faith_SR <- microbial_faith_pd$SR

# Create data frame from sample data 
phyloseq::sample_data(coral_object) %>%  
  group_by(expedition_number, BiologicalMatter,Huang_Roy_tree_name) %>%
  as.data.frame() %>%
  select(expedition_number, BiologicalMatter,Huang_Roy_tree_name)-> test_df

# Create a new column titled eco to join expedition and biological matter
test_df$eco <-paste(test_df$expedition_number,test_df$BiologicalMatter, sep = "_")

#group and count total for each unique group maintaining NA values
test_df %>% group_by(eco, Huang_Roy_tree_name) %>%  summarise(counts=n()) %>%
  ungroup %>%
  complete(nesting(eco),
           nesting(Huang_Roy_tree_name),
           fill = list(quantity = 0)) -> test_table

# Fill NA with 0
test_table[is.na(test_table)] <-0

#Build Matrix
e <- unique(test_table$eco) 
t <- unique(test_table$Huang_Roy_tree_name) 
c <- test_table$counts

test_matrix <- matrix(c, nrow = length(e), ncol = length(t), byrow=TRUE)
rownames(test_matrix) = e
colnames(test_matrix) = t

# clean data set to match each other
clean_tree <- match.phylo.comm(phy = coral_tree, comm = test_matrix)$phy
clean_comm <- match.phylo.comm(phy = coral_tree, comm = test_matrix)$comm

coral_faith_pd <- pd(clean_comm, clean_tree, include.root=TRUE)
coral_faithpd_reorded <-coral_faith_pd[order(coral_faith_pd$PD, decreasing=TRUE),] 

write.table(microbial_faith, file ="./carib_mucus_microbial_faith_pd_table.tsv", sep = ",",col.names = TRUE)

write.tsv(coral_faithpd_reorded, file ="./carib_mucus_Host_faith_pd_table.tsv" ,sep = ",",row.names = TRUE)
```

# BAR PLOTS: Coral Compartments
```{r}

##import neutral Model results tables

tissue_table <- read.table(file ="gcmp_qiime_input/Tissue_neutral_model.tsv",header=T,comment.char="", row.names=1, sep=",")
mucus_table <- read.table(file ="gcmp_qiime_input/Mucus_neutral_model.tsv",header=T,comment.char="", row.names=1, sep=",")
skeleton_table <- read.table(file ="gcmp_qiime_input/Skeleton_neutral_model.tsv",header=T,comment.char="", row.names=1, sep=",")
combined_table <- read.table(file ="gcmp_qiime_input/combined_neutral_table.tsv",header=T,comment.char="", row.names=1, sep=",")

sig_tissue <-filter(tissue_table, padj <=0.05)
sig_skeleton <-filter(skeleton_table, padj <=0.05)
sig_mucus <-filter(mucus_table, padj <=0.05)
sig_combined <-filter(combined_table, padj <=0.05)
filter(sig_combined, Phylum == "Proteobacteria") %>%
            mutate(Order= factor(Order),
                   Order= fct_reorder(Order,p, .desc = FALSE)) -> protobacteria



many_col <- c("#A6CEE3", "black","#33A02C","#E7298A","#FDBF6F", "#B2DF8A", "#1F78B4","#E31A1C","#6A3D9A", "#FF7F00","#1B9E77","#B15928", "#FB9A99", "#CAB2D6", "#377EB8","#D95F02", "#7570B3","#FFFF99","#666666" ,"#66A61E", "#E6AB02","#A6761D", "#CAB2D6",  "#B15928","#FFFF99", "#D95F02", "#E7298A", "#7570B3","#666666" , "#E6AB02", "brown3","#A6761D", "#377EB8", "#4DAF4A" ,"#984EA3", "#FFFF33","#FF7F00","cyan3", "#4DAF4A" ,"#FF7F00","#984EA3", "#A65628","#1B9E77", "#F781BF", "#F46D43","#ABDDA4", "#FDAE61","black", "#FEE08B","#E6F598","#3288BD","deeppink","#66C2A5","cyan1","red3", "#E69F00","#56B4E9","#999999","#F0E442","#0072B2","#D55E00","#D53E4F","yellow","skyblue","coral4","#A6CEE3","white","darkkhaki","brown1","#FFFF33","chocolate","darkorchid2","#FF7F00","#1B9E77","#66A61E","#FDBF6F", "#FB9A99","#A6CEE3", "#33A02C","#E7298A","#FDBF6F", "#B2DF8A", "#1F78B4","#E31A1C","#6A3D9A", "#FF7F00","#1B9E77","#B15928", "#FB9A99", "#CAB2D6", "#377EB8","#D95F02", "#7570B3","#FFFF99","#666666" ,"#66A61E", "#E6AB02")


proto_bar <- ggplot(data = protobacteria, aes(x = model, y = Order,size=p,color = Order)) +
         geom_point() + scale_color_manual(values = c(many_col))+ theme_minimal()+labs( x=" family", y="average relative abundance (p)") + guides(color="none")+ ggtitle("Non-Neutral Proteobacteria Bargraph") + theme(plot.title = element_text(hjust = 0.5))



 
  facet_wrap(~sample_type, scales= "free_x", nrow=1) +
  labs( x=" family", y="average relative abundance (p)") + guides(fill = guide_legend(title = "Order"))+ ggtitle("Non-Neutral Proteobacteria Bargraph") + scale_fill_manual(name=NULL, values = c(many_col)) 


all_bar <- ggplot(data = sig_combined, aes(x = model, y = p, fill = Phylum)) +
         geom_bar(stat = "identity", position="stack") + 
  facet_wrap(~sample_type, scales= "free_x", nrow=1) +
  labs( x=" family", y="average relative abundance (p)") + ggtitle("Compartment Neutral Bargraph") + scale_fill_manual(name=NULL, values = c(many_col)) 

mucus_bar <- ggplot(data = sig_mucus, aes(x = model, y = p, fill = Phylum)) +
         geom_bar(stat = "identity", position="stack") + 
  labs( x=" family", y="average relative abundance (p)") + ggtitle("Mucus Neutral Bargraph") + scale_fill_manual(name=NULL, values = c(many_col)) 

tissue_bar <- ggplot(data = sig_tissue, aes(x = model, y = p, fill = Phylum)) +
         geom_bar(stat = "identity", position="stack")  +
  labs( x=" family", y="average relative abundance (p)") + ggtitle("Tissue Neutral Bargraph") +  scale_fill_manual(name=NULL, values = c(many_col)) 

skeleton_bar <- ggplot(data = sig_skeleton, aes(x = model, y = p, fill = Phylum)) +
         geom_bar(stat = "identity", position="stack")  +
  labs( x=" family", y="average relative abundance (p)") + ggtitle("Skeleton Neutral Bargraph") +  scale_fill_manual(name=NULL, values = c(many_col)) 

```

# Alpha Diversity BoxPlots Compartments & Family
```{r, boxplots}
###Once we have our sub_samples rarefied we can start with some diversity analysis  and visualization
### Alpha Diversity ** you can make multiple diversity box plots by switch x for sample variables

orb_rich = estimate_richness(subject, split =T,measures = c("Observed", "Chao1", "ACE", "Shannon", "Simpson"))
comp.shannon <- pairwise.wilcox.test(orb_rich$Shannon, sample_data(subject)$BiologicalMatter, p.adjust.method = "fdr")
comp.shannon

region.shannon <- pairwise.wilcox.test(orb_rich$Shannon, sample_data(subject)$expedition_number, p.adjust.method = "fdr")
region.shannon

family.shannon <- pairwise.wilcox.test(orb_rich$Shannon, sample_data(subject)$family, p.adjust.method = "fdr")
family.shannon

## Treaments
alpha_compartment_all <- plot_richness(subject, x="BiologicalMatter", color= "BiologicalMatter", measures ="Shannon") +
  geom_boxplot(width=0.5) + geom_jitter()+ scale_color_manual(values=c("#009197","#8E3B97","#EC8C5C"))+ geom_point(na.rm = TRUE) + theme_classic() + theme(strip.background = element_blank(), plot.title = element_text(hjust = 0.5), axis.text.x.bottom = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5)) + theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) + guides(col="none") +
  geom_signif(comparisons = list(c("Coral Mucus", "Coral Tissue"), c("Coral Skeleton","Coral Mucus"), c("Coral Tissue", "Coral Skeleton")),
  map_signif_level = TRUE, y_position = c(6,5,5.5))

alpha_family_all <- plot_richness(subject, x="family", color= "family", measures = "Shannon") +
  geom_boxplot(width=0.5) + geom_jitter()+ scale_color_manual(values=many_col)+ geom_point(na.rm = TRUE) + theme_classic() + theme(strip.background = element_blank(), plot.title = element_text(hjust = 0.5), axis.text.x.bottom = element_text(size = 12, angle = 90, vjust = 0.5, hjust = 0.5)) + theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) + guides(col="none") 

alpha_region_all <- plot_richness(subject, x="expedition_number", color= "expedition_number", measures = "Shannon") +
  geom_boxplot(width=0.5) + geom_jitter()+ scale_color_manual(values=many_col)+ geom_point(na.rm = TRUE) + theme_classic() + theme(strip.background = element_blank(), plot.title = element_text(hjust = 0.5), axis.text.x.bottom = element_text(size = 12, angle = 0, vjust = 0.5, hjust = 0.5)) + theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) + guides(col="none") 



```

# Calculate DISTANCE MATRICES
```{r}
## All samples
bray_all = phyloseq::distance(subject, method="bray")
uni_all = phyloseq::distance(subject, method="unifrac")
wuni_all= phyloseq::distance(subject, method="wUnifrac")

# Create data frame for downstream analysis
all_df <- data.frame(sample_data(subject))


```

## 1. PERMANOVAs Analysis
```{r}

#env material include mucus, tissue and skeleton, and outgroups without eDNA
distance_methods <-c("bray_all","wuni_all","uni_all")

set.seed(129)
# This is what is called a for loop.        
for (i in distance_methods){ 
  form <- as.formula(paste(i,"BiologicalMatter", sep="~"))
  print(form)
 adonis2(form, data=all_df)-> result
 print(result)
}
 
set.seed(129)
# This is what is called a for loop.        
for (i in distance_methods){ 
  form <- as.formula(paste(i,"expedition_number", sep="~"))
  print(form)
 adonis2(form, data=all_df)-> result
 print(result)
}

set.seed(129)
# This is what is called a for loop.        
for (i in distance_methods){ 
  form <- as.formula(paste(i,"family", sep="~"))
  print(form)
 adonis2(form, data=all_df)-> result
 print(result)
}

## Post-hoc comparison between Coral Compartments and Location
bray_comp_pairwise <-pairwise.perm.manova(bray_all, all_df$BiologicalMatter,nperm=1000) 
bray_region_pairwise <-pairwise.perm.manova(bray_all, all_df$expedition_number,nperm=1000) 
bray_family_pairwise <-pairwise.perm.manova(bray_all, all_df$family,nperm=1000) 

wuni_comp_pairwise <-pairwise.perm.manova(wuni_all, all_df$BiologicalMatter,nperm=1000) 
wuni_region_pairwise <-pairwise.perm.manova(wuni_all, all_df$expedition_number,nperm=1000) 
wuni_family_pairwise <-pairwise.perm.manova(wuni_all, all_df$family,nperm=1000) 
#uni_all_pairwise <-pairwise.perm.manova(uni_all, all_df$expedition_number,nperm=1000)
#wuni_coral_pairwise <-pairwise.perm.manova(wuni_all,all_df$expedition_number,nperm=1000)

```



# Ordination from Distance Matrix and PCoA Plots 
```{r}
coral_color <-c("#009197","#EC8C5C","#8E3B97")
##Calculate the PCoA on Complex Corals
rt.pcoa = ordinate(rarefied, method="PCoA", distance=bray_all)
# Set variables to zero for subsequent changes
#Ofra
pcoa<-0
pcoa <- plot_ordination(subject, rt.pcoa,color="BiologicalMatter") + scale_color_manual(values=coral_color) + geom_point(size=3) + theme_bw() + stat_ellipse(level = 0.95,type = "norm",aes(group=BiologicalMatter)) + theme(legend.text=element_text(size=12))+ theme(axis.text=element_text(size=12, face = "bold"), axis.title=element_text(size=14,face="bold") + theme(text = element_text(size = 20,face = "bold")))  + ggtitle("Bray-Curtis Distance Matrix for Coral Compartments")+theme(plot.title = element_text(hjust = 0.5))

pcoa1<-0
pcoa1 <- plot_ordination(subject, rt.pcoa,color="run_lane") + scale_color_manual(values=many_col)+ geom_point(size=3) + theme_bw() + stat_ellipse(level = 0.95,type = "norm",aes(group=run_lane)) + theme(legend.text=element_text(size=12)) + theme(axis.text=element_text(size=12, face = "bold"), axis.title=element_text(size=14,face="bold") + theme(text = element_text(size = 20,face = "bold")))  + theme(text = element_text(size = 20,face = "bold")) + ggtitle("Bray-Curtis Distance Matrix for GCMP sequence runs")+theme(plot.title = element_text(hjust = 0.5))

pcoa2<-0
pcoa2 <- plot_ordination(subject, rt.pcoa,color="family") + scale_color_manual(values=many_col)+ geom_point(size=3) + theme_bw() +  stat_ellipse(level = 0.95,type = "norm",aes(group=family)) + theme(legend.text=element_text(size=12)) + theme(axis.text=element_text(size=12, face = "bold"), axis.title=element_text(size=14,face="bold") + theme(text = element_text(size = 20,face = "bold")))  + theme(text = element_text(size = 20,face = "bold"))  + ggtitle("Bray-Curtis Distance Matrix for Coral Host Family")+theme(plot.title = element_text(hjust = 0.5))

pcoa3<-0
pcoa3<- plot_ordination(subject, rt.pcoa,color="expedition_number") + scale_color_manual(values=many_col)+ geom_point(size=3) + theme_bw() +  stat_ellipse(level = 0.95,type = "norm",aes(group=expedition_number)) + theme(legend.text=element_text(size=12)) + theme(axis.text=element_text(size=12, face = "bold"), axis.title=element_text(size=14,face="bold") + theme(text = element_text(size = 20,face = "bold")))  + theme(text = element_text(size = 20,face = "bold"))  + ggtitle("Bray-Curtis Distance Matrix for Coral Host Family")+theme(plot.title = element_text(hjust = 0.5))
```

# Hclutering
```{r}
## Use Distance matricies created above

# run hclust command
hc_complex_muc <- hclust(wuni_flavo, method = "ward.D2")

# Get Tree tip label names 
coral_family <- flavo_dd$BiologicalMatter

# Add tip labels to hclust object
hc_complex_muc$labels <- coral_family

## Create the Dendrogram
dend <- as.dendrogram(hc_complex_muc)

#dend <- color_branches(dend, k=9)


## clean up plot
dend %>% set("leaves_pch", 15) %>% 
  set("leaves_cex", 0.5) %>% # adjust the leave shape size
  set("labels_cex",1.0) %>% # adjust the leave label size
  color_branches(dend, k=4) %>%
  set("labels_col", k=4) %>%
  hang.dendrogram(hang_height = -0.002) %>% # hang level
  plot(main = "Caribbean Actinomarinaceae Dendrogram",
  horiz =  FALSE,  nodePar = list(cex = 0.01))


```


## Parking lot
```{r}
## Subset glom OTU table
phyloseq::otu_table(glom)%>%
        as.data.frame()%>%
        rownames_to_column("id") -> glom_otu_table

## Subset glom tax table
phyloseq::tax_table(glom)%>%
        as.data.frame()%>%
        rownames_to_column("id") -> glom_otu_tax

## Subset glom tax table
phyloseq::sample_data(glom)%>%
        as.data.frame() -> glom_metadata

# Connnect taxonomy information to neutral  model results
inner_join(neutral_results_padj,glom_tax, by = "id") %>% as.data.frame() -> nonneutral_tax


#subset otu table based on neutral results
neutral_table <-subset(glom_otu_table, id  %in%  neutral_fam_df$id)

#subset taxonomy table based on neutral results
neutral_tax <- subset(glom_otu_tax, id  %in%  neutral_fam_df$id)# & Family %in% neutral_fam_df$Family)

#subset Metadata based on neutral results
neutral_sample_name <- colnames(neutral_table)
neutral_meta <-subset(glom_metadata,sample_name_backup %in% neutral_sample_name)
neutral_metadata <- sample_data(neutral_meta)

## This approch helps transpose the data without adding numbers as colummn id
test_table <- setNames(data.frame(t(glom_otu_table[,-1])),glom_otu_table[,1])

# create matrix format for OTU and taxonomy table
OTU2 <- otu_table(data.matrix(test_table, rownames.force = NA), taxa_are_rows = TRUE)
tax2 = tax_table(as.matrix(neutral_tax))

# Create Working phyloseq object
neutral_phylo <- phyloseq(OTU2,tax2,neutral_metadata)

neutral_phylo

############################# Glom Psudo Tables ##############################################################

########### Redo for neutral without filtering for  significant padj ########
phyloseq::tax_table(glom) %>%
  as.data.frame() %>% 
  rownames_to_column("id") -> Tissue_glom_tax

## Inner_join will connect  ASV id with taxonomy using id column
inner_join(neutral_results_padj,Tissue_glom_tax, by = "id") -> non_neutral_tax

## Subset ASV from each model and signifcance 
sig_neutral_tax = select(filter(non_neutral_tax, model == "neutral"),id,p_abundance,freq,padj,Phylum,Class,Order,Family,model)

## Subset glom OTU table
phyloseq::otu_table(glom)%>%
        as.data.frame()%>%
        rownames_to_column("id") -> glom_otu_table

##subset otu table based on neutral results and rename column names
neutral_table <-subset(glom_otu_table, id  %in%  sig_neutral_tax$id)
n <-length(neutral_table)
colnames(neutral_table)[2:n] <- paste(colnames(neutral_table)[2:n], "neutral", sep = "_")

## Subset metadata file
data.frame(sample_data(glom)) %>% select(sample_name_backup, expedition_number,host_scientific_name) %>% as.data.frame() -> glom_meta

## Create new columns for the metadata data
glom_meta %>% mutate(psuedo_sample_name = paste(colnames(neutral_table)[2:n]),
                         compartment_neutraility = paste("Tissue", "neutral", sep = '_'),
                         compartment = paste ("Tissue"),
                         neutraility = paste("neutral")) %>% 
                         as.data.frame() -> glom_metadata

psuedo_table_name <- paste0("Tissue","_","neutral_table.csv")
(write.csv(neutral_table, file =psuedo_table_name, row.names = FALSE))

psuedo_map_name <- paste0("Tissue","_","neutral_metadata.csv")
(write.csv(glom_metadata, file =psuedo_map_name, row.names = FALSE))

psuedo_tax_name <- paste0("Tissue","_","neutral_taxonomy.csv")
(write.csv(subset_tax, file =psuedo_tax_name, row.names = FALSE))
# Subset Taxonomy and join with neutral model results
neutral = c("above","below")
for (i in neutral){
phyloseq::tax_table(glom) %>%
  as.data.frame() %>% 
  rownames_to_column("id") -> glom_tax
## Inner_join will connect  ASV id with taxonomy using id column
inner_join(neutral_results_padj,glom_tax, by = "id") -> non_neutral_tax

## Subset ASV from each model and signifcance 
sig_neutral_tax = select(filter(non_neutral_tax, model == i & padj <=0.05),id,p_abundance,freq,padj,Phylum,Class,Order,Family,model)

## Subset glom OTU table
phyloseq::otu_table(glom)%>%
        as.data.frame()%>%
        rownames_to_column("id") -> glom_otu_table

#subset otu table based on neutral results and rename column names
neutral_table <-subset(glom_otu_table, id  %in%  sig_neutral_tax$id)
l = length(neutral_table)
colnames(neutral_table)[2:l] <- paste(colnames(neutral_table)[2:l], i, sep = "_")

## Subset metadata file
data.frame(sample_data(glom)) %>% select(sample_name_backup, expedition_number,host_scientific_name) %>% as.data.frame() -> glom_meta
## Create new columns for the metadata data
glom_meta %>% mutate(psuedo_sample_name = paste(colnames(neutral_table)[2:299]),
                         compartment_neutraility = paste("mucus", i, sep = '_'),
                         compartment = paste ("mucus"),
                         neutraility = paste(i)) %>% 
                         as.data.frame() -> glom_metadata

## Subset significant results with taxonomy to retain only significant taxonomy
subset_tax <- subset(glom_tax, id %in% sig_neutral_tax$id) %>% 
  select(-c("Genus","Species"))

psuedo_table_name <- paste0("mucus","_",i,"_table.tsv")
(write.table(neutral_table, file =psuedo_table_name, row.names = FALSE))

psuedo_map_name <- paste0("mucus","_",i,"_metadata.tsv")
(write.table(glom_metadata, file =psuedo_map_name, row.names = FALSE))

psuedo_tax_name <- paste0("mucus","_",i,"_taxonomy.tsv")
(write.table(subset_tax, file =psuedo_tax_name, row.names = FALSE))

}

########### Redo for neutral without filtering for  significant padj ########
phyloseq::tax_table(glom) %>%
  as.data.frame() %>% 
  rownames_to_column("id") -> glom_tax

## Inner_join will connect  ASV id with taxonomy using id column
inner_join(neutral_results_padj,glom_tax, by = "id") -> non_neutral_tax

## Subset ASV from each model and signifcance 
sig_neutral_tax = select(filter(non_neutral_tax, model == "neutral"),id,p_abundance,freq,padj,Phylum,Class,Order,Family,model)

## Subset glom OTU table
phyloseq::otu_table(glom)%>%
        as.data.frame()%>%
        rownames_to_column("id") -> glom_otu_table

##subset otu table based on neutral results and rename column names
neutral_table <-subset(glom_otu_table, id  %in%  sig_neutral_tax$id)
colnames(neutral_table)[2:299] <- paste(colnames(neutral_table)[2:299], "neutral", sep = "_")

## Subset metadata file
data.frame(sample_data(glom)) %>% select(sample_name_backup, expedition_number,host_scientific_name) %>% as.data.frame() -> glom_meta

## Create new columns for the metadata data
glom_meta %>% mutate(psuedo_sample_name = paste(colnames(neutral_table)[2:299]),
                         compartment_neutraility = paste("mucus", "neutral", sep = '_'),
                         compartment = paste ("mucus"),
                         neutraility = paste("neutral")) %>% 
                         as.data.frame() -> glom_metadata

psuedo_table_name <- paste0("mucus","_","neutral_table.tsv")
(write.table(neutral_table, file =psuedo_table_name, row.names = FALSE))

psuedo_map_name <- paste0("mucus","_","neutral_metadata.tsv")
(write.table(glom_metadata, file =psuedo_map_name, row.names = FALSE))

psuedo_tax_name <- paste0("mucus","_","neutral_taxonomy.tsv")
(write.table(subset_tax, file =psuedo_tax_name, row.names = FALSE))




```
```